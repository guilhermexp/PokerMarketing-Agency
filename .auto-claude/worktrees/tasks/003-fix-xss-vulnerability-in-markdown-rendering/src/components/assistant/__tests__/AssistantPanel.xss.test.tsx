import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { AssistantPanel } from '../AssistantPanel';
import type { ChatMessage } from '../../../types';

/**
 * XSS Protection Tests for AssistantPanel
 *
 * These tests verify that the parseMarkdown function properly escapes
 * HTML entities and prevents XSS attacks while still supporting markdown.
 */

describe('AssistantPanel - XSS Protection', () => {
  const defaultProps = {
    isOpen: true,
    onClose: () => {},
    history: [] as ChatMessage[],
    isLoading: false,
    onSendMessage: () => {},
    referenceImage: null,
    onClearReference: () => {},
  };

  describe('Script Injection Protection', () => {
    it('should escape <script> tags in message content', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<script>alert("XSS")</script>' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      // Verify script tag is escaped and rendered as text
      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;script&gt;');
      expect(content?.innerHTML).toContain('&lt;/script&gt;');
      expect(content?.innerHTML).not.toContain('<script>');
    });

    it('should escape script tags with attributes', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<script src="evil.js"></script>' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;script');
      expect(content?.innerHTML).not.toContain('<script');
    });
  });

  describe('Event Handler Protection', () => {
    it('should escape onclick event handlers', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<img src=x onclick="alert(\'XSS\')">' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;img');
      expect(content?.innerHTML).not.toContain('onclick=');
    });

    it('should escape onerror event handlers', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<img src=x onerror="alert(\'XSS\')">' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;img');
      expect(content?.innerHTML).not.toContain('onerror=');
    });

    it('should escape onload event handlers', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<body onload="alert(\'XSS\')">' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;body');
      expect(content?.innerHTML).not.toContain('onload=');
    });
  });

  describe('URL-based Attack Protection', () => {
    it('should escape javascript: URLs', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<a href="javascript:alert(\'XSS\')">click</a>' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;a href');
      expect(content?.innerHTML).not.toContain('javascript:');
    });

    it('should escape data: URLs with HTML', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<a href="data:text/html,<script>alert(\'XSS\')</script>">click</a>' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;a href');
      expect(content?.innerHTML).not.toContain('<script>');
    });
  });

  describe('HTML Entity Protection', () => {
    it('should escape ampersands', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: 'Test & Test' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&amp;');
    });

    it('should escape less-than signs', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '5 < 10' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;');
    });

    it('should escape greater-than signs', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '10 > 5' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&gt;');
    });

    it('should escape quotes', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: 'He said "hello" and she said \'hi\'' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&quot;');
      expect(content?.innerHTML).toContain('&#39;');
    });
  });

  describe('Complex XSS Attack Vectors', () => {
    it('should escape SVG with embedded scripts', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<svg onload="alert(\'XSS\')"><circle/></svg>' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;svg');
      expect(content?.innerHTML).not.toContain('onload=');
    });

    it('should escape iframe injection', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<iframe src="javascript:alert(\'XSS\')"></iframe>' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;iframe');
      expect(content?.innerHTML).not.toContain('<iframe');
    });

    it('should escape object/embed tags', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<object data="javascript:alert(\'XSS\')"></object>' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;object');
      expect(content?.innerHTML).not.toContain('<object');
    });

    it('should escape style tags with expressions', () => {
      const maliciousMessage: ChatMessage = {
        role: 'model',
        parts: [{ text: '<style>body{background:url("javascript:alert(\'XSS\')")}</style>' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[maliciousMessage]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;style&gt;');
      expect(content?.innerHTML).not.toContain('<style>');
    });
  });

  describe('Markdown Functionality After Escaping', () => {
    it('should render bold text correctly after escaping', () => {
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: '**bold text**' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      const strong = container.querySelector('strong');
      expect(strong).toBeTruthy();
      expect(strong?.textContent).toBe('bold text');
    });

    it('should render italic text correctly after escaping', () => {
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: '*italic text*' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      const em = container.querySelector('em');
      expect(em).toBeTruthy();
      expect(em?.textContent).toBe('italic text');
    });

    it('should render inline code correctly after escaping', () => {
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: '`code here`' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      const code = container.querySelector('code');
      expect(code).toBeTruthy();
      expect(code?.textContent).toBe('code here');
    });

    it('should render code blocks correctly after escaping', () => {
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: '```\nconst x = 5;\n```' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      const pre = container.querySelector('pre');
      expect(pre).toBeTruthy();
      const code = pre?.querySelector('code');
      expect(code?.textContent).toContain('const x = 5;');
    });

    it('should render lists correctly after escaping', () => {
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: '* Item 1\n* Item 2' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      const ul = container.querySelector('ul');
      expect(ul).toBeTruthy();
      const items = ul?.querySelectorAll('li');
      expect(items?.length).toBe(2);
    });

    it('should handle mixed markdown and HTML entities correctly', () => {
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: '**Bold & <script>alert("XSS")</script>**' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      const strong = container.querySelector('strong');
      expect(strong).toBeTruthy();
      expect(strong?.innerHTML).toContain('&amp;');
      expect(strong?.innerHTML).toContain('&lt;script&gt;');
      expect(strong?.innerHTML).not.toContain('<script>');
    });
  });

  describe('Edge Cases', () => {
    it('should handle empty messages', () => {
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: '' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      expect(container).toBeTruthy();
    });

    it('should handle messages with only whitespace', () => {
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: '   \n\n   ' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      expect(container).toBeTruthy();
    });

    it('should handle very long XSS attempts', () => {
      const longXSS = '<script>' + 'alert("XSS");'.repeat(1000) + '</script>';
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: longXSS }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;script&gt;');
      expect(content?.innerHTML).not.toContain('<script>');
    });

    it('should handle nested HTML tags', () => {
      const message: ChatMessage = {
        role: 'model',
        parts: [{ text: '<div><span><script>alert("XSS")</script></span></div>' }],
      };

      const { container } = render(
        <AssistantPanel {...defaultProps} history={[message]} />
      );

      const content = container.querySelector('.prose');
      expect(content?.innerHTML).toContain('&lt;div&gt;');
      expect(content?.innerHTML).toContain('&lt;span&gt;');
      expect(content?.innerHTML).not.toContain('<div>');
      expect(content?.innerHTML).not.toContain('<span>');
    });
  });
});
