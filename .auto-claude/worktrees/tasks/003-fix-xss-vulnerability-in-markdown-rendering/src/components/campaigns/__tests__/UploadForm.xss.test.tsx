import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { UploadForm } from '../UploadForm';
import type { BrandProfile } from '../../../types';

/**
 * XSS Protection Tests for UploadForm
 *
 * These tests verify that the UploadForm component properly handles user input
 * and does not introduce XSS vulnerabilities through text inputs or file uploads.
 *
 * Note: UploadForm does not contain a parseMarkdown function (verified in subtask-1-2).
 * These tests ensure the component remains XSS-safe in its current implementation.
 */

describe('UploadForm - XSS Protection', () => {
  const mockBrandProfile: BrandProfile = {
    companyName: 'Test Company',
    industry: 'Technology',
    targetAudience: 'Developers',
    brandVoice: 'Professional',
    toneOfVoice: 'Profissional',
    keywords: ['test', 'security'],
    competitorAnalysis: 'Test competitors',
    uniqueSellingPoints: ['Quality', 'Security'],
    primaryColor: '#000000',
    secondaryColor: '#ffffff',
    logoUrl: null,
  };

  const defaultProps = {
    onGenerate: vi.fn(),
    isGenerating: false,
    brandProfile: mockBrandProfile,
    onUpdateCreativeModel: vi.fn(),
    styleReferences: [],
    selectedStyleReference: null,
    onSelectStyleReference: vi.fn(),
    onClearSelectedStyleReference: vi.fn(),
  };

  describe('Text Input Protection', () => {
    it('should safely handle script tags in textarea input', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      // Attempt to inject script
      const maliciousInput = '<script>alert("XSS")</script>';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify the input is stored as plain text
      expect(textarea).toHaveValue(maliciousInput);

      // Verify no script tags are executed in the DOM
      const scripts = container.querySelectorAll('script');
      const injectedScripts = Array.from(scripts).filter(
        (script) => script.textContent?.includes('alert("XSS")')
      );
      expect(injectedScripts.length).toBe(0);
    });

    it('should safely handle event handlers in textarea input', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      // Attempt to inject event handler
      const maliciousInput = '<img src=x onerror="alert(\'XSS\')">';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify the input is stored as plain text
      expect(textarea).toHaveValue(maliciousInput);

      // Verify no img tags with onerror are in the DOM
      const images = container.querySelectorAll('img[onerror]');
      expect(images.length).toBe(0);
    });

    it('should safely handle iframe injection attempts', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      // Attempt to inject iframe
      const maliciousInput = '<iframe src="javascript:alert(\'XSS\')"></iframe>';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify the input is stored as plain text
      expect(textarea).toHaveValue(maliciousInput);

      // Verify no iframes are created from user input
      const iframes = container.querySelectorAll('iframe');
      const injectedIframes = Array.from(iframes).filter((iframe) =>
        iframe.src.includes('javascript:')
      );
      expect(injectedIframes.length).toBe(0);
    });

    it('should safely handle SVG with embedded scripts', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      // Attempt to inject SVG with script
      const maliciousInput = '<svg onload="alert(\'XSS\')"><circle/></svg>';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify the input is stored as plain text
      expect(textarea).toHaveValue(maliciousInput);

      // Verify no SVG elements with onload are in the DOM
      const svgs = container.querySelectorAll('svg[onload]');
      expect(svgs.length).toBe(0);
    });
  });

  describe('HTML Entity Handling', () => {
    it('should handle ampersands in text input', () => {
      render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const input = 'Test & Test & More';
      fireEvent.change(textarea, { target: { value: input } });

      expect(textarea).toHaveValue(input);
    });

    it('should handle less-than and greater-than signs', () => {
      render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const input = '5 < 10 and 10 > 5';
      fireEvent.change(textarea, { target: { value: input } });

      expect(textarea).toHaveValue(input);
    });

    it('should handle quotes in text input', () => {
      render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const input = 'He said "hello" and she said \'hi\'';
      fireEvent.change(textarea, { target: { value: input } });

      expect(textarea).toHaveValue(input);
    });
  });

  describe('URL-based Attack Protection', () => {
    it('should safely handle javascript: URLs in text', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const maliciousInput = '<a href="javascript:alert(\'XSS\')">Click me</a>';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify no anchor tags with javascript: URLs are created
      const links = container.querySelectorAll('a[href^="javascript:"]');
      expect(links.length).toBe(0);
    });

    it('should safely handle data: URLs with HTML', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const maliciousInput =
        '<a href="data:text/html,<script>alert(\'XSS\')</script>">Click</a>';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify no data: URLs with HTML are created
      const links = container.querySelectorAll('a[href^="data:text/html"]');
      expect(links.length).toBe(0);
    });
  });

  describe('Component Rendering Safety', () => {
    it('should not use dangerouslySetInnerHTML with user input', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const maliciousInput = '<script>alert("XSS")</script>';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Check that textarea value is not rendered via dangerouslySetInnerHTML
      const elementsWithHTML = container.querySelectorAll('[dangerouslySetInnerHTML]');
      const hasUserContent = Array.from(elementsWithHTML).some((el) =>
        el.innerHTML.includes('<script>alert("XSS")</script>')
      );
      expect(hasUserContent).toBe(false);
    });

    it('should render component without XSS vulnerabilities', () => {
      const { container } = render(<UploadForm {...defaultProps} />);

      // Verify no executable scripts are present from malicious sources
      const scripts = container.querySelectorAll('script');
      const maliciousScripts = Array.from(scripts).filter(
        (script) =>
          script.textContent?.includes('alert(') ||
          script.textContent?.includes('eval(') ||
          script.textContent?.includes('document.cookie')
      );
      expect(maliciousScripts.length).toBe(0);
    });
  });

  describe('Complex Attack Vectors', () => {
    it('should handle nested HTML tags safely', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const maliciousInput =
        '<div><span><script>alert("XSS")</script></span></div>';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify nested structure doesn't execute
      const nestedScripts = container.querySelectorAll('div > span > script');
      expect(nestedScripts.length).toBe(0);
    });

    it('should handle style injection attempts', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const maliciousInput =
        '<style>body{background:url("javascript:alert(\'XSS\')")}</style>';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify style tags are not injected
      const styleTags = Array.from(container.querySelectorAll('style')).filter(
        (style) => style.textContent?.includes('javascript:')
      );
      expect(styleTags.length).toBe(0);
    });

    it('should handle object/embed tag injection', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const maliciousInput = '<object data="javascript:alert(\'XSS\')"></object>';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify object tags are not created
      const objects = container.querySelectorAll('object');
      const maliciousObjects = Array.from(objects).filter((obj) =>
        obj.getAttribute('data')?.includes('javascript:')
      );
      expect(maliciousObjects.length).toBe(0);
    });

    it('should handle base64 encoded XSS attempts', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      // Base64 encoded: <script>alert('XSS')</script>
      const maliciousInput =
        '<img src="data:image/svg+xml;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=">';
      fireEvent.change(textarea, { target: { value: maliciousInput } });

      // Verify encoded scripts don't execute
      const images = Array.from(container.querySelectorAll('img')).filter(
        (img) =>
          img.src.includes('data:image/svg+xml;base64') &&
          img.src.includes('PHNjcmlwdD')
      );
      expect(images.length).toBe(0);
    });
  });

  describe('Edge Cases', () => {
    it('should handle empty input safely', () => {
      render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      fireEvent.change(textarea, { target: { value: '' } });
      expect(textarea).toHaveValue('');
    });

    it('should handle very long input with XSS attempts', () => {
      render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const longInput =
        'Safe text '.repeat(100) + '<script>alert("XSS")</script>';
      fireEvent.change(textarea, { target: { value: longInput } });

      expect(textarea).toHaveValue(longInput);
    });

    it('should handle special characters and unicode', () => {
      render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const unicodeInput = 'æµ‹è¯• ðŸš€ <script>alert("XSS")</script> ðŸ”¥';
      fireEvent.change(textarea, { target: { value: unicodeInput } });

      expect(textarea).toHaveValue(unicodeInput);
    });

    it('should handle multiple XSS attempts in one input', () => {
      const { container } = render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      const multipleXSS =
        '<script>alert(1)</script><img src=x onerror=alert(2)><iframe src="javascript:alert(3)"></iframe>';
      fireEvent.change(textarea, { target: { value: multipleXSS } });

      // Verify none of the XSS attempts work
      expect(container.querySelectorAll('script')).toHaveLength(0);
      expect(container.querySelectorAll('img[onerror]')).toHaveLength(0);
      expect(container.querySelectorAll('iframe[src^="javascript:"]')).toHaveLength(0);
    });
  });

  describe('Verification: No parseMarkdown Function', () => {
    it('should not contain parseMarkdown function in component', () => {
      // This test documents that UploadForm does not have a parseMarkdown function
      // as verified in subtask-1-2. The component handles user input safely through
      // React's default escaping behavior in controlled inputs.

      const componentSource = UploadForm.toString();
      expect(componentSource).not.toContain('parseMarkdown');
      expect(componentSource).not.toContain('dangerouslySetInnerHTML');
    });

    it('should rely on React default escaping for security', () => {
      // UploadForm uses controlled textarea inputs which are automatically
      // escaped by React, providing XSS protection without custom sanitization
      render(<UploadForm {...defaultProps} />);
      const textarea = screen.getByPlaceholderText('Descreva sua ideia...');

      // Verify textarea is a controlled input (safe by default)
      expect(textarea).toBeInstanceOf(HTMLTextAreaElement);
      expect(textarea.tagName).toBe('TEXTAREA');
    });
  });
});
